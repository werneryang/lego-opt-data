# 4 周项目计划

## 背景
本项目负责期权链数据的下载、管理与清洗，数据来源为 IB Gateway/TWS，覆盖 S&P 500 美股期权链。目标是在 macOS 开发环境验证后，迁移至 Linux 定时执行。

## 范围与里程碑
- **M1（第 1 周）**：完成 IB 连接器、合约发现缓存、限速器、Parquet 存储脚手架；实现从 2024-10-01 起的回填流程（原始 + 清洗输出）。
- **M2（第 2 周）**：完善公司行动调整、清洗逻辑、数据验证；实现交易日 17:00 ET 自动更新（幂等、可恢复）。
- **M3（第 3 周）**：增加调度脚本（macOS `launchd`/Linux `systemd`）、运行日志、监控指标、失败恢复流程；完成周度 compaction 管道。
- **M4（第 4 周）**：联调与性能调优；完善文档（运维手册、Runbook、数据契约）；准备部署到 Linux，完成试运行验收。

## 关键任务拆解
- **连接与发现**：基于 `ib_insync`，实现 IB 会话、合约发现、缓存持久化。
- **速率控制与队列**：按请求类别实现令牌桶限速、退避策略、可恢复任务队列。
- **数据采集与过滤**：应用行权价 ±30% 与标准月度/季度筛选，获取全量字段（Greeks、IV、OI）。
- **清洗与公司行动**：归一化字段、处理缺失值、输出 raw/clean/adjusted 视图。
- **存储与压缩**：Parquet 分区 `date/underlying/exchange`，Snappy 热分区、ZSTD 冷分区，周度合并。
- **调度与运维**：CLI/Makefile、配置模板、运行日志、恢复机制、告警钩子。

## 范围边界
- 不涵盖实时逐笔数据；以日级快照为主。
- 不包括非 S&P 500 标的或指数期权，除非后续追加。
- 不负责云端部署，仅覆盖本地与指定 Linux 主机。

## 风险与缓解
- **IB 限速/权限不足**：初期使用保守限速，必要时申请更高权限或分批执行。
- **字段缺失/延迟**：实现补采与回填机制，记录缺失字段并在清洗阶段标注。
- **公司行动复杂度**：维护外部事件表，必要时人工校验；提供原始与调整视图并记录差异。
- **数据量大导致存储压力**：通过分区压缩、周度合并、冷热分离缓解。
- **调度失败**：Runbook 提供手动恢复步骤，状态文件支持断点续跑。

## 里程碑验收标准
- M1：回填成功覆盖 S&P 500 至今，raw/clean 数据完整，可重跑零失败。
- M2：定时任务连续运行 3 个交易日无异常，清洗后数据通过 QA 检查。
- M3：调度脚本在 macOS/Linux 可用，告警/日志清晰，周度合并生效。
- M4：Linux 环境全量跑通，文档完整，运行手册可根据其独立恢复故障。

## 进展快照（2025-09-26）
- 已实现 IB 合约发现接口、回填队列与执行器骨架，可输出 raw/clean/adjusted 三层数据（含测试覆盖）。
- 清洗流水线和公司行动调整（基于拆分因子）落地，数据契约、Runbook 已同步更新。
- 自动化测试（`make install && make test`）通过；真实 IB Gateway 联调待上线环境完成。
