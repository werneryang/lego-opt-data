# 2025-12-07 Daily Option History Fetcher

## New Features
- **Daily Option History Fetcher**: Implemented a robust mechanism to fetch daily historical option data using IBKR's 8-hour bar aggregation workaround (since 1-day bars are unavailable for options).
- **CLI Command**: Added `history` command to `opt_data.cli`.
  - Usage: `python -m opt_data.cli history --symbols AAPL --days 30`
  - Options: `--force-refresh` to bypass contracts cache.

## Improvements
- **Contract Discovery**: Enhanced `HistoryRunner` to fetch the underlying's reference price (historical close) before discovery. This resolves the "No contracts found" error caused by the moneyness filter rejecting all strikes when `ref_price` was 0.0.
- **Resilience**: Added retry logic and better error handling for "HMDS query returned no data" (Error 162), which is common for illiquid contracts.

## Technical Details
- **8-Hour Bars**: Fetches 8-hour bars (approx. 2 per day) and aggregates them into a single daily record (Open, High, Low, Close, Volume).
- **Data Path**: Aggregated data is saved to `data/clean/ib/chain/ib/history/<SYMBOL>/<DATE>/<CONID>.json`.
