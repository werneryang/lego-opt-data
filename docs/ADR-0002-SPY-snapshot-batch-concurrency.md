# ADR-0002：SPY 收盘快照批并发策略（实验性）

- **日期**：2025-12-04
- **状态**：提议（Proposed）/实验性（Experimental）
- **作者**：项目组

## 背景

项目当前的正式方案在期权链收盘快照阶段（`snapshot.py` → `collect_option_snapshots(mode="reqtickers")`）采用：

- 批量 `reqTickers` 获取行情快照；
- 按固定 `batch_size`（默认 50）将合约分批；
- 批与批之间 **顺序执行**，不做批级并发。

该策略在全 S&P 500 标的、实时/冻结行情环境下可以较好地遵守 IBKR pacing 限制和线路上限，稳定性优先。但在单标的（例如 SPY）收盘快照场景下，顺序批处理的总耗时相对较长（数分钟级），影响本地分析和实验效率。

为此，团队在 `data_test` 目录下引入了实验脚本 `data_test/SPY_auto_test_snapshot.py`，使用自定义的批级并发逻辑评估 Frozen 场景下的性能上限，并观察对错误率与链条覆盖度的影响。本 ADR 用于记录该实验的设计、结果与当前阶段的决策。

## 方案

### 基线实现（顺序批 reqTickers）

- 场景：
  - 标的：`SPY@SMART`；
  - 行情模式：`marketDataType=2`（Frozen），收盘后执行；
  - 合约池：基于 `reqSecDefOptParams` 返回的到期日和行权价，选择：
    - 近端 30 天内所有周五；
    - 若干远端月度/季度第三周五（含周四/周六编码）；
    - 围绕现价按 5 美元步长取 ±25 档行权价（50 个 strikes），Call/Put 双边；
    - 理论合约数约 1500。
- 实现：
  - 使用 `data_test/SPY_auto_collect_snapshot.py` 调用 `collect_option_snapshots(..., mode="reqtickers", batch_size=50)`；
  - 无批级并发，批之间顺序执行。
- 代表性结果（仅作量级参考）：
  - 实际返回行数：约 1492/1500；
  - 总耗时：约 426 秒；
  - 行级 `snapshot_error`（超时）集中于少数远端或极端行权价。

### 实验实现（批级并发 + fallback）

实验脚本：`data_test/SPY_auto_test_snapshot.py`，核心改动如下：

1. **合约构造与过滤**
   - 使用 `reqSecDefOptParams` 获取 SPY 期权链；
   - 到期日与行权价选择与基线一致；
   - 使用 secDef 返回的 `strikes` 作为白名单，仅对链条上存在的行权价构造 Option 合约，减少 “No security definition”/Unknown contract。

2. **批级并发控制**
   - 将合约列表划分为批次：
     - `batch_size=50`：每批约 50 个合约；
     - 批总数约 30（1500 / 50）。
   - 使用 `asyncio.Semaphore` 控制批级并发：
     - `batch_concurrency=3`：最多允许 3 个批次并行执行 `reqTickersAsync(*batch)`；
     - 每个批次内部仍由 `reqTickers` 负责合约级并发。

3. **fallback 机制**
   - 若某批次在调用过程中出现异常（如单批请求失败、网络错误），将该批拆分为更小的子批：
     - `fallback_batch_size=25`：拆分后每个子批约 25 合约；
     - 子批重新排入队列重试（标记为 fallback，以便统计）。
   - 若 fallback 批仍然失败，则按合约级别写入错误行（`snapshot_error=true`，`error_type=batch_error`）。

4. **批次统计与错误统计**
   - 对每个批次记录：
     - 批号、批大小、是否 fallback；
     - 执行耗时（毫秒）；
     - 错误信息（如有）。
   - 汇总输出：
     - 总批次数、批级错误数；
     - 平均批耗时与最大批耗时；
     - 行级 `snapshot_error` 数量/总行数。

5. **运行参数**
   - 环境变量：
     - `IB_MARKET_DATA_TYPE=2`（必须为 Frozen）；
     - `BATCH_SIZE`（默认 50）；
     - `BATCH_SIZE_FALLBACK`（默认 25）；
     - `BATCH_CONCURRENCY`（默认 1，可提升到 3）；
     - `SNAPSHOT_TIMEOUT`（默认 30 秒）。

### 实测结果（代表性运行）

> 下列数据均为单次实验结果，仅作量级参考，不代表所有环境和账户。

- 场景：`IB_MARKET_DATA_TYPE=2`，`batch_size=50`，`fallback_batch_size=25`，`batch_concurrency=3`，`timeout=30s`。
- 结果 1（未启用 strike 过滤的早期版本）：
  - 实际返回行数：1492/1500；
  - 批次数：30 个；
  - 总耗时：约 168.8 秒；
  - 批级错误数：0；
  - 行级 `snapshot_error`：25/1492。
- 结果 2（启用 strike 过滤后）：
  - 实际返回行数：1492/1500；
  - 批次数：30 个；
  - 总耗时：约 169.9 秒；
  - 批级错误数：0；
  - 行级 `snapshot_error`：4/1492（集中于个别远端到期/冷门行权价）。

对比基线顺序批实现，可见：

- 性能：总耗时从约 426 秒降至约 170 秒，提速约 2–3 倍；
- 完整性：在 Frozen 场景下，批级并发 3 并未明显恶化行级错误率，尤其在启用 strike 过滤后，`snapshot_error` 数量下降到数条。

## 决策

1. **生产环境仍采用顺序批 reqTickers**
   - 对于生产调度（全 S&P 500、全天 30 分钟快照 + 收盘快照）：
     - 继续使用现有的顺序批模式；
     - 不在库层引入批级并发参数，也不调整 `collect_option_snapshots(mode="reqtickers")` 的默认行为。
   - 理由：
     - 生产环境的标的数量和运行频率远高于单标的实验，pacing 风险与失败重试复杂度显著增大；
     - 现有顺序模式已满足目前的数据时效性要求，稳定性优先。

2. **批并发策略限定在 data_test/实验脚本**
   - `data_test/SPY_auto_test_snapshot.py` 被明确标记为：
     - 用于 SPY 收盘 Frozen 场景的性能实验与调优；
     - 不作为生产调度路径的一部分。
   - 若需要评估其他标的（如 AAPL/MSFT），可复制该脚本并调整：
     - 标的代码、到期日筛选逻辑；
     - 行权价窗口；
     - 并发参数（建议从 `batch_concurrency=1` 起步）。

3. **使用建议**
   - 建议在以下场景使用该策略：
     - 本地/测试环境，希望快速抓取 SPY 收盘期权链用于研究、回测或模型校准；
     - 运维人员在评估 IB 行情稳定性或测试账户配额时，需要可控地放大请求压力。
   - 不建议直接在以下场景使用：
     - 正式生产 cron/调度任务；
     - 多标的同时运行，或在未知 pacing 配额的账户上长时间运行。

4. **文档与运维手册更新**
   - 在 `docs/ops-runbook.md` 中增加 “SPY 收盘快照批并发调优经验（实验，仅限 data_test）” 小节，说明实验前提、参数与风险；
   - 在 `docs/基于 ib_insync 的 TWS 期权链数据拉取方案（增强版）.md` 中添加“性能与节流策略补充：SPY 收盘快照批并发（实验性）”段落，强调：
     - 该策略为实验性；
     - 主体方案仍然是顺序批 reqTickers。

## 影响

- **正面影响**
  - 为收盘快照和本地实验提供了一种可验证的提速手段，特别是针对单标的 SPY 链；
  - 验证了在适度批并发和 Frozen 行情前提下，reqTickers 的性能可以显著提升，同时错误率仍然可控；
  - 为后续可能的生产级优化提供了实测基线和参数区间参考。

- **潜在风险**
  - 若误将批并发参数推广到生产环境，可能在多标的叠加下触发 IB pacing violation 或连接中断；
  - 在不同账户（尤其是权限/配额不同的账户）上，允许的并发度和速率上限可能差异较大，实验参数不可直接复用。

- **缓解措施**
  - 将批并发逻辑封装在 `data_test` 脚本，不修改生产库实现；
  - 在文档中明确标注“实验性/仅限 data_test 使用”，并在需要推广时要求新增 ADR 评估；
  - 如果未来评估将批并发引入生产，需要：
    - 引入可配置的并发与节流参数；
    - 在测试配置环境完成多标的回归；
    - 增强对 pacing violation、超时比率的监控与告警。

## 后续行动

1. 持续收集更多标的（如 AAPL、MSFT）的实验数据，评估批并发策略在不同链规模和账户上的表现；
2. 如有必要，在 `SnapshotRunner` 层设计“实验模式”开关，允许在测试配置中显式启用批并发，同时保证正式配置默认关闭；
3. 定期复盘该 ADR 的状态：
   - 若实验结果在更广泛场景下证实可行，考虑将状态从“提议/实验性”升级为“接受（Accepted）”，并规划分阶段引入生产；
   - 若发现稳定性风险或成本过高，可将状态更新为“拒绝（Rejected）”，并在文档中记录原因。

