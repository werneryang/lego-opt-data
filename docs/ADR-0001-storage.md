# ADR-0001：数据存储架构与周度合并策略

- **日期**：2025-09-26
- **状态**：提议（Proposed）
- **作者**：项目组

## 背景
期权链数据覆盖 S&P 500 全量合约，字段包含价格、希腊值、成交量、持仓量等。每日回填与更新可能产生大量小文件，若未规划压缩策略与合并机制，将导致 I/O 低效、下游查询困难。

## 决策
1. 原始与清洗数据均使用 Parquet 格式，按 `date=YYYY-MM-DD/underlying=SYM/exchange=EXCH` 三级分区存储。
2. 分区压缩策略：最近 `hot_days`（默认 14 天）使用 Snappy 以加快读写；更早分区统一改写为 ZSTD（level 6–9）。
3. 设置周度合并任务：
   - 合并同一分区内的小文件，目标 Parquet 文件大小 128–256MB。
   - 合并过程中完成冷分区的压缩格式转换（Snappy → ZSTD）。
   - 合并信息与版本记录写入 `state/run_logs/`。
4. 写入流程采用“临时文件 → 原子重命名”策略，确保失败不会产生半成品。

## 影响
- 优点：
  - 提升读取性能，降低元数据压力。
  - 简化冷数据备份策略（ZSTD 更高压缩率）。
  - 热分区仍保持较快的增量写入性能。
- 代价：
  - 需要额外的合并任务与状态管理。
  - 冷数据查询前需确认是否已合并（避免重复读取旧文件）。

## 备选方案与理由
- **仅使用 Snappy，无合并任务**：实现简单，但随着时间推移，文件碎片化严重，查询和备份成本上升，权衡后放弃。
- **使用 Delta Lake / Iceberg 等表格式**：提供 ACID 与版本管理，但当前需求以批量写入为主，额外引入组件复杂度大，暂不采用。
- **改用列式数据库（ClickHouse/Parquet on S3）**：需额外部署与维护，且本阶段定位于本地/单节点运行，不符合现阶段资源约束。

## 后续行动
- 在 `config/opt-data.toml` 内暴露 `hot_days`、压缩级别、合并调度窗口供调参。
- 在 `docs/ops-runbook.md` 中记录合并任务的执行频率与失败恢复步骤。
- 定期评估数据规模与查询模式，必要时 revisit 本决策。
