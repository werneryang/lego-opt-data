# ADR-0001：日内快照存储与合并策略

- **日期**：2025-09-26
- **状态**：提议（Proposed）
- **作者**：项目组

## 背景
项目切换为 30 分钟实时快照 + 17:00 日终归档流程，`view=intraday` 每日写入 14 个槽位（按标的/交易所拆分），若直接逐槽落单个 Parquet 文件，会导致小文件膨胀与元数据压力。需要在保证幂等性的前提下规划写入策略、压缩策略以及合并/降冷流程。

## 决策
1. 所有视图（raw/clean/daily_adjusted/enrichment）均使用 Parquet，路径 `data/<layer>/ib/chain/view=<view>/date=YYYY-MM-DD/underlying=SYM/exchange=EXCH`。
2. 热分区（最近 `hot_days`，默认 14 天）使用 Snappy；老分区统一转换为 ZSTD（level 6–9），并记录压缩策略版本。
3. 写入流程采用“临时文件 → 原子重命名”模式；同一槽位的重复写入以覆盖旧文件为主（`trade_date, sample_time, conid` 幂等）。
4. 周度合并任务（默认周六 09:00 ET）负责：
   - 合并 intraday/daily 分区内小文件，目标单文件 128–256MB；
   - 冷数据压缩格式转换（Snappy → ZSTD）；
   - 记录结果到 `state/run_logs/compaction_*.jsonl` 与指标（输入/输出文件数、耗时）。
5. 可选的“当日小文件合并”在 17:10 ET 触发，仅对当日 intraday 分区进行本地合并（默认关闭）；适用于磁盘极度受限或下游即席查询性能要求较高的场景。
6. 引入保留策略：intraday 仅保留 `intraday_retain_days`（默认 60 天），超过阈值的分区迁移至冷存储或删除（配置可控）。

## 影响
- 优点：
  - 控制 30 分钟快照产生的小文件数量，降低元数据和查询压力。
  - 热数据使用 Snappy 确保写入/读取性能，冷数据 ZSTD 提升压缩率。
  - 合并任务与保留策略相结合，磁盘使用可预测，适配扩容。
- 代价：
  - 周度合并与保留流程需要额外调度与状态管理。
  - 当日小文件合并需谨慎处理幂等与覆盖逻辑，默认关闭以降低复杂度。

## 备选方案与理由
- **仅保留周度合并**：实现简单但当日文件过多时可能影响后续 QA 与查询；当前默认仍只开周度合并，如遇性能瓶颈再启用同日合并。
- **引入 Delta Lake/Iceberg**：虽可获得 ACID 管理与 Schema 演进能力，但现阶段在本地/单机环境成本较高，暂不采用。
- **实时写入行式数据库（ClickHouse 等）**：对实时查询友好但引入额外基础设施，与当前轻量化目标不符。

## 写入与合并细节
- **文件布局**：每次槽位写入可以按 “当日单文件追加” 或 “单槽单文件” 实现，推荐使用具备行组大小控制的 Writer，将同日多槽数据写入少量文件。
- **幂等策略**：使用 `(trade_date, sample_time, conid)` 作键，对应重跑时先读现有文件并在内存去重，再写回新文件；或在 Writer 层通过临时目录 + 合并写入确保最终文件唯一。
- **日志**：每个写入/合并任务需记录输入/输出文件列表、压缩编解码、异常信息，存放于 `state/run_logs/`。
- **监控指标**：至少跟踪分区文件数、平均文件大小、合并耗时、压缩比以及保留策略删除数量。

## 保留策略
- `intraday_retain_days` 默认 60 天，可根据磁盘压力调整；删除/冷存储动作需保留操作日志，支持 dry-run。
- Daily/Adjusted 视图保留全量历史，依赖 ZSTD 压缩与周度合并控制体量。
- Enrichment 记录（如 OI 回补）与 daily 同步保留，避免缺失追踪。

## 后续行动
- 在 `config/opt-data.toml` 暴露 `hot_days`、`target_file_size_mb`、`intraday_retain_days`、`same_day_compaction_enabled` 等配置。
- 在 `docs/ops-runbook.md` 补充周度合并/保留流程、同日合并启用条件、故障恢复步骤。
- 定期评估文件规模、合并耗时，必要时 revisit 本决策或引入更强的表格式解决方案。
